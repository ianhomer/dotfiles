#!/usr/bin/env python3

#
# Generate cheats for streaming into fzf
#

import os, re, sys, fileinput, getopt
from pathlib import Path

def usage():
  scriptName = os.path.basename(__file__)
  print(f"{scriptName}")

COMMAND_CHAR="⌘"
SHIFT_CHAR="⇧"
CONTROL_CHAR="⌃"
OPTION_CHAR="⌥"
SPACE_CHAR="␣"

lineFormat = "\u001b[0m {command:15s} \u001b[32m{application:10s}" + \
    " \u001b[33m{context:10s} \u001b[36m {definition:s} \u001b[30m{hidden:s}"

metas = []

application = "default"
context = "main"
mark = ""
command = "n/a"
definition = "definition"
lastWasCommand = 0

DEBUG=0

def printLine(meta):
  print(lineFormat.format(**meta))

def debug(message):
  if DEBUG: print("DEBUG : " + message)

def transformCommand(command):
  return command \
      .replace("Cmd+",COMMAND_CHAR) \
      .replace("Shift+",SHIFT_CHAR) \
      .replace("Ctrl+",CONTROL_CHAR) \
      .replace("Option+",OPTION_CHAR) \
      .replace("space+",SPACE_CHAR)

def parse(line):
  global application, context, command, definition, mark, lastWasCommand
  debug("line - " + line)
  # Heading 
  match = re.search('^(#+) (.*)$', line)
  if match:
    debug("heading : " + match.group(1) + ":" + match.group(2))
    headingDepth=len(match.group(1))
    if headingDepth == 2:
      application = match.group(2)
    else:
      context = match.group(2)
    lastWasCommand = 0
    return
  # Command
  match = re.search('\*\*([^\*\s]*)\*\*', line)
  if match:
    debug("command " + match.group(1))
    command = match.group(1)
    lastWasCommand = 1
    return
  definition=line
  # Definition
  match = re.search('^: ([^;:\.]+).*$', line)
  if lastWasCommand and match:
    printLine({
      "application": application,
      "context": context,
      "command": transformCommand(command),
      "definition": match.group(1),
      "hidden" : command
    })
  lastWasCommand = 0

def main(argv):
  for line in fileinput.input():
    parse(line.rstrip())

  for meta in metas:
    printLine(meta)

if __name__ == "__main__":
  main(sys.argv[1:])

