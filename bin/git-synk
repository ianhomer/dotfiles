#!/usr/bin/env bash

#
# Safe synchronisation of git repository. Auto-commits can be enabled by setting
# the git config core.autocommit, i.e. run the following once in the repository
# directory
#
#    git synk -a
#
# Autocommitting should only be enabled when the commit messages are of limited
# value, for example personal / note style repositories.

set -e

help() {
  cat <<EOF

    git synk -a  # autocommit
    git synk -u  # unset autocommmit

EOF
}

OPTIND=1
while getopts "ahu" o; do case "$o" in
  a) git config core.autocommit true ;;
  u) git config --unset core.autocommit ;;
  h) help && exit 1 ;;
esac done

# Make sure in git repository
git rev-parse

fullBranchName=$(git symbolic-ref -q HEAD)
branchName=${fullBranchName##refs/heads/}
originUrl=$(git config --get remote.origin.url)

changes=$(git status --porcelain | wc -l)

if [[ $changes -gt 0 ]] ; then
  if [[ "true" == `git config core.autocommit` ]] ; then
    # Handle dirty state only if autocommit flag set
    git add -A ; git commit -m "sync"
  else
    echo "Cannot sync - local changes and autocommit not set"
    exit 128
  fi
fi

git pull -r --quiet

git push --porcelain

echo "Synced $branchName on $originUrl"
