#!/usr/bin/env bash

set -e
$(shim) && . ${ME}/i.sh

i=0

# Get user ID so that it can be used in grep of ps to find process that start
# with named command
uid=$(id -u)

# Close apps that are reasonable safe to just close. Useful as a housekeeping
# step to free up resources

# For nvim, this closes all proceses without lock in the process name
# Start vim with nvim +lock to withstand this close process
# This process of closing nvim relies on nvim autosaving files, this process
# does not save files
for application in nvim Flipper.app node ; do
  log:: closing $application
  for process in $(ps -o pid,uid,command | grep "$uid $application" | grep -v -E 'lock|grep' | awk '{ print $1; }') ; do
    name=$(ps -o command= -p $process)
    directory=$(lsof -p $process | grep cwd | sed 's/  */ /g' | cut -d " " -f9- )
    kill -3 $process
    log:: OK closed $process $name $directory
    ((i=i+1))
  done
done

[ $i -eq 1 ] && plural="" || plural="s"

log:: DONE close closed ${i} app${plural}
