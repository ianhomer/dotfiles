#!/usr/bin/env bash

set -e
$(shim) && . ${ME}/i.sh

i=0
unclosed=0

# Get user ID so that it can be used in grep of ps to find process that start
# with named command
uid=$(id -u)

# Close apps that are reasonable safe to just close. Useful as a housekeeping
# step to free up resources

# For nvim, this closes all proceses without lock in the process name
# Start vim with nvim +lock to withstand this close process
# This process of closing nvim relies on nvim autosaving files, this process
# does not save files
for application in nvim Flipper.app node ; do
  log:: closing $application
  for process in $(ps -o pid,uid,command | grep "$uid $application" | grep -v -E 'lock|grep' | awk '{ print $1; }') ; do
    name=$(ps -o command= -p $process)
    log:: closing $process
    kill -3 $process
    directory=$(lsof -p $process | grep cwd | sed 's/  */ /g' | cut -d " " -f9- )
    stillRunningName=$(ps -o command= -p $process || echo "")
    if [ -n "${stillRunningName}" ] ; then
      log:: NOK not-closed $process $name $directory
      ((unclosed=unclosed+1))
      if [ "$1" == "-f" ] ; then
        kill -9 $process
        log:: OK force-closed $process $name $directory
        ((i=i+1))
      fi
    else
      log:: OK closed $process $name $directory
      ((i=i+1))
    fi
  done
done

[ $i -eq 1 ] && plural="" || plural="s"

log:: DONE close closed ${i} app${plural}

if [ $unclosed -gt 0 ] ; then
  log::error run closeme -f to force close
fi
