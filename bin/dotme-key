#!/usr/bin/env bash

$(shim) && cd ${ME} && . bin/i.sh
log::info "Setting up SSH key"

if [[ -z "$1" ]] ; then
   . ${ME}/bin/dotenv
else
  MY_EMAIL=$1
fi
log::info "My email ${MY_EMAIL}"

if [[ -z "$MY_EMAIL" ]] ; then
  log:: "... set email with"
  log:: "    dotme set EMAIL my@com"
  exit 1
fi

keyFile=~/.ssh/id_dotme

if [[ ! -f $keyFile ]] ; then
  log:: "... creating SSH key for : $MY_EMAIL"
  ssh-keygen -t ed25519 -C $MY_EMAIL \
    -f $keyFile                          \
    -q -N ""
fi

log:: "... key file = ${keyFile}.pub"
if hash pbcopy 2>/dev/null ; then
  cat "${keyFile}.pub" | pbcopy
  log:: "... public key is in clipboard"
else
  cat "${keyFile}.pub"
fi

sshConfig="$HOME/.ssh/config"
if [[ ! -f ${sshConfig} ]] ; then
  log:: "Creating "
cat <<EOF > ${sshConfig}
Host *
  AddKeysToAgent yes
  UseKeychain yes
  IdentityFile ${keyFile}
EOF
fi

