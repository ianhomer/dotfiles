#!/usr/bin/env bash

#
# Backup my files
#

set -e

$(shim) && . ${ME}/i.sh

EXCLUDES_FILE=~/.dotfiles/dotfiles/rsync/.config/rsync/rsync-excludes.txt
LOG_DIR=~/local/logs
[[ ! -d $LOG_DIR ]] && echo hello && mkdir $LOG_DIR
LOG_LOCATION=~/local/logs/bak-me-$(date "++%Y%m%d-%H%M%S").log
stamp=$(date "+%Y/%m/%d/%H%M%S")

# r - archive => -rlptgoD
# P - partial and progress
# b - make incremental backups

args="--stats --exclude-from=${EXCLUDES_FILE}"
args="$args -Pab --delete --backup-dir $stamp"
args="$args --log-file=$LOG_LOCATION"
log:: "rsync args : $args"

BACKUP_ROOT=~/tmp

BACKUP_DESTINATION=$BACKUP_ROOT/backup/$(scutil --get ComputerName)-$USER

if [[ ! -d $BACKUP_DESTINATION ]] ; then
  #
  # Prefer explicit creation of backup destination to prevent unintended
  # consequences if destination not as expected
  #
  echo "Create directory $BACKUP_DESTINATION to enable backup flow"
  exit 1
fi

rsync ${args} ~/gdrive $BACKUP_DESTINATION
rsync ${args} ~/projects/things $BACKUP_DESTINATION
rsync ${args} ~/.dotfiles $BACKUP_DESTINATION

log:: "Backup size"
fileCount=$(find $BACKUP_DESTINATION -type f | wc -l)
log:: "File count destination : $fileCount"
if compgen -G "$BACKUP_DESTINATION/20*" > /dev/null ; then
  for history in $BACKUP_DESTINATION/20* ; do
    historyFileCount=$(find $history -type f | wc -l)
    log:: "File count history $(basename $history) : $historyFileCount"
  done
else
  log:: "No files in history (yet)"
fi

log:: "Files size"
du -sch $BACKUP_DESTINATION

