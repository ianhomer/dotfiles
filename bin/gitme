#!/bin/bash

#
# Report on work in local git repositories that need pushing to remote
#

FETCH_WINDOW=600

while getopts "n:rw:" o; do case "$o" in
  n) MAX=$OPTARG ;;
  r) REMOTE=y ;;
  w) FETCH_WINDOW=$OPTARG ;;
esac done

NL=$'\n'
count=0

# Show a concise report of git status
function showDirectoryStatus {
  #printf '\033[1;33m'
  #echo "-->"
  branches=$(git branch -v | grep "\[ahead\|\[behind")
  branchLines=$(echo $branches | tr -d '\n' | wc -c)
  status=$(git status --porcelain)
  statusLines=$(echo $status | tr -d '\n' | wc -c)
  if [[ $branchLines -gt 0 || $statusLines -gt 0 || "$REMOTE" == "y" ]] ; then
    printf '\033[0;35m'
    [[ "$REMOTE" != "y" ]] && git rev-parse --show-toplevel
    if [[ $branchLines -gt 0 ]] ; then
      printf '\033[0;37m'
      echo "${branches}"
    fi
    if [[ $statusLines -gt 0 ]] ; then 
      printf '\033[0m'
      echo "${status}"
    fi
  fi
}

# Show status of recently entered directories
for d in `git-get-directories` ; do
  [[ "$REMOTE" == "y" ]] && (
    cd $d
    printf '\033[0;35m'
    git rev-parse --show-toplevel
    if [[ `git remote | wc -l` -eq 0 ]] ; then
      printf "\e[0;37mno remote\n"
    else
      now=`date +%s`
      lastModified=`stat -f '%c' .git/FETCH_HEAD`
      if [[ $((lastModified + FETCH_WINDOW)) < $now ]] ; then
        printf '\033[0;33m'
        git remote update
        git pull
      else
        printf "\e[0;37mâˆ· Fetched %ss ago\n" $((now - lastModified))
      fi
    fi
  )
  (cd $d ; showDirectoryStatus)
  ((count++))
  [[ -n "${MAX}" && ${count} -ge ${MAX} ]] && break
done
echo "Scanned ${count} Git directories"
