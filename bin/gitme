#!/bin/bash

#
# Report on work in local git repositories that need pushing to remote
#

OPTIND=1
while getopts "r" opt; do case "$opt" in
  r) REMOTE=y ;;
esac done

NL=$'\n'
count=0

# Show a concise report of git status
function showDirectoryStatus {
  #printf '\033[1;33m'
  #echo "-->"
  branches=$(git branch -v | grep "\[ahead\|\[behind")
  branchLines=$(echo $branches | tr -d '\n' | wc -c)
  status=$(git status --porcelain)
  statusLines=$(echo $status | tr -d '\n' | wc -c)
  if [[ $branchLines -gt 0 || $statusLines -gt 0 ]] ; then
    printf '\033[0;35m'
    git rev-parse --show-toplevel
    if [[ $branchLines -gt 0 ]] ; then
      printf '\033[0;37m'
      echo "${branches}"
    fi
    if [[ $statusLines -gt 0 ]] ; then 
      printf '\033[0m'
      echo "${status}"
    fi
  fi
}

# Show status of recently entered directories
for d in `git-get-directories` ; do
  printf '\033[0;33m'
  [[ "$REMOTE" == "y" ]] && git remote update
  (cd $d ; showDirectoryStatus)
  ((count++))
done
echo "Scanned ${count} Git directories"
