#!/usr/bin/env bash

#
# Install brew packages
#

set -e

while getopts "a" o; do case "$o" in
  a) ADMIN=y ;;
esac done

$(shim) && . ${ME}/i.sh
i:: log

BREW_DIR=${DOTFILES_DIR}/config/brew

if [[ "$ADMIN" != "y" ]] ; then
  should-run -m 7 $0 $BREW_DIR/Brewfile || exit 0
fi

if ! is-executable brew ; then
  o_o "installing brew"
  curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install \
    | ruby
fi

adminFormula="adoptopenjdk8 adoptopenjdk11 java11 openjdk@11 powershell"

# Pin formula that need password to upgrade if not in admin mode
for formula in $adminFormula ; do
  if [[ "$ADMIN" == "y" ]] ; then
    o_o "unpinning $formula"
    brew unpin $formula > /dev/null 2>&1 || o_o "not unpinned $formula"
  else
    brew pin $formula > /dev/null 2>&1 || o_o "not pinned $formula"
  fi
done

o_o "updating brew"
# Use latest version of brew
brew update

o_o "upgrading brew"
# Upgrade any already installed formulae
brew upgrade

cd $SCRIPT_DIR/../config/brew
brew bundle

if [[ "$ADMIN" == "y" ]] ; then
  o_o "installing admin packages"
  cd $SCRIPT_DIR/../config/brew/admin
  brew bundle
fi

# Restart Alfred - it might have updated, and it's quick to recycle, so until I
# can be cleverer about restarting when updated ...
osascript -e 'tell application "Alfred" to quit'
/usr/bin/open -a "Alfred 4"

should-run -fu $0
