#!/usr/bin/env sh

#
# Configure nnn
#
# Based on https://github.com/jarun/nnn/blob/master/plugins/getplugs
#

should-run $0 || exit

printf "\e[36mConfiguring nnn\e[0m\n"

CONFIG_DIR=${XDG_CONFIG_HOME:-"$HOME/.config"}/nnn
BOOKMARKS_DIR=${XDG_CACHE_HOME:-"$HOME/.cache"}/nnn/bookmarks
PLUGIN_DIR=${CONFIG_DIR}/plugins

VER=`nnn -V`
ARCHIVE_URL=https://github.com/jarun/nnn/releases/download/v"$VER"/nnn-v"$VER".tar.gz

mkdir -p "$PLUGIN_DIR"
cd "$CONFIG_DIR" || exit 1
DOWNLOAD_FILE=nnn-"$VER".tar.gz

if [[ ! -f $DOWNLOAD_FILE ]] ; then
  curl -Ls "$ARCHIVE_URL" -o $DOWNLOAD_FILE
fi
if [[ ! -d nnn-"$VER" ]] ; then
  tar -zxf nnn-"$VER".tar.gz
fi
cd nnn-"$VER"/plugins || exit 1

plugins=".nnn-plugin-helper bookmarks fzcd fzopen preview-tui"
ignore=""
for plugin in $plugins ; do ignore="${ignore}(?<!${plugin})" ; done

stow -v -t $PLUGIN_DIR --ignore $ignore .

[[ ! -d $BOOKMARKS_DIR ]] && mkdir -p $BOOKMARKS_DIR
cd $BOOKMARKS_DIR
[[ ! -f downloads ]] && ln -s ~/Downlads downloads

should-run -fu $0
