#!/usr/bin/env python3

#
# Set up base line kitty session
#

import json
import os
import subprocess
from functools import cached_property


class KittyState:
    def __init__(self):
        self.state = json.loads(subprocess.check_output(["kitty", "@", "ls"]))

    def print(self):
        for window in self.state:
            print(window)
            for tab in window["tabs"]:
                print(tab["title"])

    @cached_property
    def tabTitles(self):
        titles = []
        for window in self.state:
            for tab in window["tabs"]:
                titles.append(tab["title"])
        return titles


class Kitty:
    def __init__(self):
        self.state = KittyState()

    def action(self, action):
        os.system("kitty @ " + action)

    def launchTab(self, title, directory):
        if title not in self.state.tabTitles:
            self.action(
                "launch --type=tab --tab-title "
                + title
                + " --cwd "
                + directory
                + " fish"
            )
        else:
            print("Tab already exists : " + title)


print("Initialising my kitty")
kitty = Kitty()

print("Current tabs : " + ",".join(kitty.state.tabTitles))
kitty.launchTab("dot", "~/.dotfiles")
kitty.launchTab("garden", "~/projects/my/digital-garden")
kitty.launchTab("things", "~/projects/things")
kitty.action("focus-tab --match 'title:^dot'")
print("... complete")
